<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripPrep - AI 여행 준비 보고서</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>TripPrep</h1>
            <p>AI가 완벽한 여행 준비 보고서를 만들어드립니다.</p>
        </header>

        <main>
            <section id="input-section" class="card">
                <form id="trip-form">
                    <div class="form-group">
                        <label for="destination">여행지</label>
                        <input type="text" id="destination" name="destination" placeholder="예: 일본 도쿄, 프랑스 파리" required>
                    </div>

                    <div class="form-group">
                        <label for="keywords">관심 키워드 (쉼표로 구분)</label>
                        <input type="text" id="keywords" name="keywords" placeholder="예: 맛집, 쇼핑, 박물관">
                    </div>

                    <button type="submit" id="generate-btn" class="btn-primary">
                        <span class="btn-text">보고서 생성하기</span>
                        <div class="loader" style="display: none;"></div>
                    </button>
                </form>
            </section>

            <section id="loading-section" style="display: none;">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <h2>AI가 여행 정보를 수집하고 있습니다...</h2>
                    <p id="loading-status">Scout Agent가 정찰 중입니다...</p>
                </div>
            </section>

            <section id="result-section" style="display: none;">
                <div class="result-header">
                    <h2>여행 준비 보고서</h2>
                    <button id="download-btn" class="btn-secondary">PDF 다운로드</button>
                </div>
                <div id="report-content" class="markdown-body">
                    <!-- Report will be injected here -->
                </div>
                <button id="reset-btn" class="btn-text-only">다시 만들기</button>
            </section>
        </main>

        <!-- Hidden container for PDF generation -->
        <div id="pdf-hidden"></div>
    </div>

    <script>
        const form = document.getElementById('trip-form');
        const inputSection = document.getElementById('input-section');
        const loadingSection = document.getElementById('loading-section');
        const resultSection = document.getElementById('result-section');
        const reportContent = document.getElementById('report-content');
        const loadingStatus = document.getElementById('loading-status');
        const generateBtn = document.getElementById('generate-btn');
        const btnText = generateBtn.querySelector('.btn-text');
        const loader = generateBtn.querySelector('.loader');
        const pdfHidden = document.getElementById('pdf-hidden');

        const statusMessages = [
            "Scout Agent가 정찰 중입니다...",
            "현지 법적 요구사항을 확인하고 있습니다...",
            "Architect Agent가 맞춤형 템플릿을 설계 중입니다...",
            "Writer Agent가 보고서를 작성하고 있습니다...",
            "거의 다 되었습니다!"
        ];

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const destination = document.getElementById('destination').value;
            const keywords = document.getElementById('keywords').value.split(',').map(k => k.trim()).filter(k => k);

            // UI Transition
            inputSection.style.display = 'none';
            loadingSection.style.display = 'flex';

            // Status rotation
            let msgIndex = 0;
            const statusInterval = setInterval(() => {
                msgIndex = (msgIndex + 1) % statusMessages.length;
                loadingStatus.textContent = statusMessages[msgIndex];
            }, 3000);

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ destination, keywords }),
                });

                const data = await response.json();

                if (response.ok) {
                    clearInterval(statusInterval);
                    loadingSection.style.display = 'none';
                    resultSection.style.display = 'block';

                    // Render Markdown
                    const htmlContent = marked.parse(data.report);
                    reportContent.innerHTML = htmlContent;
                } else {
                    throw new Error(data.error || '보고서 생성 실패');
                }
            } catch (error) {
                clearInterval(statusInterval);
                alert('오류가 발생했습니다: ' + error.message);
                loadingSection.style.display = 'none';
                inputSection.style.display = 'block';
            }
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            resultSection.style.display = 'none';
            inputSection.style.display = 'block';
            form.reset();
            reportContent.innerHTML = '';
            pdfHidden.innerHTML = '';
        });

        document.getElementById('download-btn').addEventListener('click', () => {
            // 1. Copy content
            pdfHidden.innerHTML = '<div class="markdown-body">' + reportContent.innerHTML + '</div>';

            // 2. Make it visible for html2canvas
            pdfHidden.style.display = 'block';

            const opt = {
                margin: 10,
                filename: 'TripPrep_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // 3. Generate and then hide
            html2pdf().set(opt).from(pdfHidden).save().then(() => {
                pdfHidden.style.display = 'none';
                pdfHidden.innerHTML = '';
            }).catch(err => {
                console.error(err);
                pdfHidden.style.display = 'none';
            });
        });
    </script>
</body>

</html>